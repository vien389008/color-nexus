<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>6x6 Flow Generator - Blocked</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        font-family: monospace;
        background: #111;
        color: #0f0;
        padding: 20px;
      }
      button {
        padding: 10px 20px;
        margin-bottom: 20px;
        cursor: pointer;
      }
      pre {
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <button id="generate">Generate 10 Maps</button>
    <pre id="output"></pre>

    <script>
      $(function () {
        const SIZE = 6;
        const TOTAL = SIZE * SIZE;
        const PATH_COUNT = 2; // có thể đổi
        const MAP_COUNT = 30;

        function xyToIndex(x, y) {
          return y * SIZE + x;
        }
        function indexToXY(i) {
          return { x: i % SIZE, y: Math.floor(i / SIZE) };
        }

        function neighbors(i) {
          const { x, y } = indexToXY(i);
          const dirs = [
            [1, 0],
            [-1, 0],
            [0, 1],
            [0, -1],
          ];
          const arr = [];
          for (let d of dirs) {
            let nx = x + d[0],
              ny = y + d[1];
            if (nx >= 0 && nx < SIZE && ny >= 0 && ny < SIZE) {
              arr.push(xyToIndex(nx, ny));
            }
          }
          return arr;
        }

        function randomColor() {
          const min = 60,
            max = 200;
          const r = Math.floor(Math.random() * (max - min)) + min;
          const g = Math.floor(Math.random() * (max - min)) + min;
          const b = Math.floor(Math.random() * (max - min)) + min;
          return (
            "#" +
            r.toString(16).padStart(2, "0") +
            g.toString(16).padStart(2, "0") +
            b.toString(16).padStart(2, "0")
          );
        }

        function generateMap() {
          while (true) {
            // 1️⃣ Random blocked (6–10 ô)
            const blocked = [];
            const blockCount = Math.floor(Math.random() * 5) + 6;

            while (blocked.length < blockCount) {
              const r = Math.floor(Math.random() * TOTAL);
              if (!blocked.includes(r)) blocked.push(r);
            }

            const freeCells = [];
            for (let i = 0; i < TOTAL; i++) {
              if (!blocked.includes(i)) freeCells.push(i);
            }

            if (freeCells.length < PATH_COUNT * 2) continue;

            // capacity = 1 cho free
            const capacity = new Array(TOTAL).fill(0);
            freeCells.forEach((i) => (capacity[i] = 1));

            const paths = [];

            function backtrack() {
              if (paths.length === PATH_COUNT) {
                return capacity.every((c) => c === 0);
              }

              let start = -1;
              for (let i of freeCells) {
                if (capacity[i] > 0) {
                  start = i;
                  break;
                }
              }

              if (start === -1) return false;

              capacity[start]--;
              const path = [start];

              function extend(pos) {
                if (path.length >= 2) {
                  paths.push([...path]);
                  if (backtrack()) return true;
                  paths.pop();
                }

                for (let n of neighbors(pos).sort(() => Math.random() - 0.5)) {
                  if (capacity[n] > 0) {
                    capacity[n]--;
                    path.push(n);

                    if (extend(n)) return true;

                    path.pop();
                    capacity[n]++;
                  }
                }

                return false;
              }

              if (extend(start)) return true;

              capacity[start]++;
              return false;
            }

            if (!backtrack()) continue;

            // 2️⃣ Build endpoints
            const endpoints = [];
            const usedColors = new Set();

            for (let i = 0; i < PATH_COUNT; i++) {
              const path = paths[i];

              let color;
              do {
                color = randomColor();
              } while (usedColors.has(color));
              usedColors.add(color);

              endpoints.push({ index: path[0], color });
              endpoints.push({ index: path[path.length - 1], color });
            }

            return {
              endpoints,
              blocked,
            };
          }
        }

        $("#generate").click(function () {
          $("#output").text("Generating maps... ⏳");

          setTimeout(() => {
            let output = "";

            for (let i = 1; i <= MAP_COUNT; i++) {
              const data = generateMap();

              output += `// Map ${i}\n`;
              output += `{\n`;
              output += `  size: 6,\n`;
              output += `  endpoints: [\n`;

              data.endpoints.forEach((e, idx) => {
                output += `    { index: ${e.index}, color: "${e.color}" }`;
                if (idx < data.endpoints.length - 1) output += ",";
                output += "\n";
              });

              output += `  ],\n`;
              output += `  blocked: [${data.blocked.join(", ")}],\n`;
              output += `},\n\n`;
            }

            $("#output").text(output);
          }, 100);
        });
      });
    </script>
  </body>
</html>
